# 'Development' docker file.  Rename this to 'Dockerfile' and follow the instructions below.
#  This dockerfile is intended for checking out a git revision of a jitsi-videobridge repo, 
#  building it, and running it.
#
# To build:
# > docker build -t videobridge .
# Example run:
# > docker run -d --net=host -e REST_PORT=8086 -e MEDIA_SINGLE_PORT=5007 videobridge
# NOTE: When connecting to this bridge, you'll need to use the docker host ip (which, unless
#  you're running linux, is probably not the same as your machine ip)
FROM ubuntu:trusty

MAINTAINER bbaldino <brian@highfive.com>

ENV VIDEOBRIDGE_HASH="eefe69a2458267a4e7b677fdcacbf2d982f5eac3"

ENV APIS="rest"
ENV MEDIA_SINGLE_PORT="5005"
ENV REST_PORT="8081"
ENV MEDIA_MIN_PORT="10000"
ENV MEDIA_MAX_PORT="20000"


# Install videobridge and dependencies
USER root
# To get 'add-apt-repository'
RUN apt-get install -y software-properties-common
# Add a separate repo to install java 1.8
RUN add-apt-repository -y ppa:webupd8team/java
# Need this to auto-accept the java license prompt that would pop up otherwise
RUN echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | sudo /usr/bin/debconf-set-selections

RUN apt-get update && apt-get -y install \
  maven \
  git \
  oracle-java8-installer \
  oracle-java8-set-default

# Create videobridge user
RUN mkdir /jvb && \
  groupadd -r jvb && \
  useradd -r -g jvb -d /jvb -s /sbin/nologin -c "Jitsi Videobridge User" jvb && \
  chown -R jvb:jvb /jvb

# Configure and run
USER jvb

WORKDIR /jvb
RUN git clone https://github.com/parlaylabs/jitsi-videobridge.git 
WORKDIR /jvb/jitsi-videobridge
RUN git checkout ${VIDEOBRIDGE_HASH}
RUN mvn clean install

RUN mkdir /jvb/.sip-communicator
RUN echo "org.jitsi.impl.neomedia.transform.srtp.SRTPCryptoContext.checkReplay=false" > /jvb/.sip-communicator/sip-communicator.properties

# Create the run script
RUN echo "#!/bin/bash" > run.sh
# We want to be able to pass these in at container-run-time, not container-build-time.  So echo these lines into the run script
#  just before we run it
# NOTE: we escape the environment variables here so the run.sh script evaluates them at runtime, otherwise they'll be set as the default set in
#  this file
RUN echo "echo \"org.jitsi.videobridge.SINGLE_PORT_HARVESTER_PORT=\$MEDIA_SINGLE_PORT\" >> /jvb/.sip-communicator/sip-communicator.properties" >> run.sh
RUN echo "echo \"org.jitsi.videobridge.rest.jetty.port=\$REST_PORT\" >> /jvb/.sip-communicator/sip-communicator.properties" >> run.sh

RUN echo "mvn exec:java -Dexec.args=\"--apis=$APIS\" -Djava.library.path=/root/videobridge/jitsi-videobridge/lib/native/linux-64 -Djava.util.logging.configile=/root/videobridge/jitsi-videobridge/lib/logging.properties -Dnet.java.sip.communicator.SC_HOME_DIR_NAME=.sip-communicator" >> run.sh
RUN chmod +x ./run.sh

CMD ./run.sh
